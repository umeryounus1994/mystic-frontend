<ngx-spinner bdColor="rgba(51,51,51,0.8)" size="medium" color="#fff" type="ball-scale-multiple" [fullScreen]="true">
    <p style="font-size: 30px; color: white">{{ 'FORMS.UPDATING_ACTIVITY' | translate }}</p>
</ngx-spinner>

<!-- Header -->
<div class="row mb-4">
    <div class="col-12 d-sm-flex justify-content-between align-items-center">
        <div>
            <button class="btn btn-light btn-sm me-3" (click)="goBack()">
                <i class="bi bi-arrow-left me-2"></i>{{ 'COMMON.BACK' | translate }} {{ 'COMMON.TO' | translate }} {{ 'SIDEBAR.ACTIVITIES' | translate }}
            </button>
            <h1 class="h3 mb-0">{{ 'COMMON.EDIT' | translate }} {{ 'SIDEBAR.ACTIVITIES' | translate }}</h1>
        </div>
    </div>
</div>

<!-- Main Form -->
<div class="row g-4">
    <div class="col-xl-12">
        <div class="card shadow">
            <div class="card-body">
                <form class="row g-4" [formGroup]="activityForm" *ngIf="activityForm" (ngSubmit)="onSubmit()">
                    
                    <!-- Basic Information -->
                    <div class="col-12">
                        <h5 class="mb-3">{{ 'FORMS.BASIC_INFORMATION' | translate }}</h5>
                    </div>
                    
                    <div class="col-lg-6">
                        <label class="form-label">{{ 'FORMS.ACTIVITY_TITLE' | translate }} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" [placeholder]="'FORMS.ENTER_ACTIVITY_TITLE' | translate" maxlength="100"
                               formControlName="title"
                               [ngClass]="{ 'is-invalid': (submitted || f['title'].touched) && f['title'].errors }">
                        <div *ngIf="(submitted || f['title'].touched) && f['title'].errors" class="invalid-feedback">
                            <div *ngIf="f['title'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['title'].errors?.['minlength']">{{ 'VALIDATION.QUEST_TITLE_MIN' | translate }}</div>
                            <div *ngIf="f['title'].errors?.['maxlength']">{{ 'VALIDATION.QUEST_TITLE_MAX' | translate }}</div>
                        </div>
                        <small class="text-muted">5-100 {{ 'VALIDATION.CHARACTERS' | translate }}</small>
                    </div>

                    <div class="col-lg-6">
                        <label class="form-label">{{ 'COMMON.CATEGORY' | translate }} *</label>
                        <select class="form-select" formControlName="category"
                                [ngClass]="{ 'is-invalid': submitted && f['category'].errors }">
                            <option value="" disabled>{{ 'FORMS.SELECT_CATEGORY' | translate }}</option>
                            <option *ngFor="let cat of categories" [value]="cat.value">{{cat.label}}</option>
                        </select>
                        <div *ngIf="submitted && f['category'].errors" class="invalid-feedback">
                            <div *ngIf="f['category'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">{{ 'COMMON.DESCRIPTION' | translate }} <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="4" [placeholder]="'FORMS.ENTER_ACTIVITY_DESCRIPTION' | translate" maxlength="500"
                                  formControlName="description"
                                  [ngClass]="{ 'is-invalid': (submitted || f['description'].touched) && f['description'].errors }"></textarea>
                        <div *ngIf="(submitted || f['description'].touched) && f['description'].errors" class="invalid-feedback">
                            <div *ngIf="f['description'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['description'].errors?.['minlength']">{{ 'VALIDATION.QUEST_QUESTION_MIN' | translate }}</div>
                            <div *ngIf="f['description'].errors?.['maxlength']">{{ 'VALIDATION.QUEST_QUESTION_MAX' | translate }}</div>
                        </div>
                        <small class="text-muted">10-500 {{ 'VALIDATION.CHARACTERS' | translate }}</small>
                    </div>

                    <!-- Pricing & Duration -->
                    <div class="col-12 mt-4">
                        <h5 class="mb-3">{{ 'FORMS.PRICING_DURATION' | translate }}</h5>
                    </div>

                    <div class="col-lg-4">
                        <label class="form-label">{{ 'TABLES.PRICE' | translate }} ($) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="1.00" min="1" step="0.01"
                               formControlName="price"
                               (keydown)="preventNegativeInput($event)"
                               (input)="validatePriceInput($event)"
                               [ngClass]="{ 'is-invalid': (submitted || f['price'].touched) && f['price'].errors }">
                        <div *ngIf="(submitted || f['price'].touched) && f['price'].errors" class="invalid-feedback">
                            <div *ngIf="f['price'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['price'].errors?.['min']">{{ 'VALIDATION.PRICE_MIN' | translate }}</div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.MINIMUM' | translate }}: $1.00</small>
                    </div>

                    <div class="col-lg-4">
                        <label class="form-label">{{ 'FORMS.ACTIVITY_DURATION' | translate }} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="10" min="10"
                               formControlName="duration"
                               [ngClass]="{ 'is-invalid': (submitted || f['duration'].touched) && f['duration'].errors }">
                        <div *ngIf="(submitted || f['duration']?.touched) && f['duration'].errors" class="invalid-feedback">
                            <div *ngIf="f['duration'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['duration'].errors?.['min']">{{ 'VALIDATION.DURATION_MIN' | translate }}</div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.MINIMUM' | translate }}: 10 {{ 'COMMON.MINUTES' | translate }}</small>
                    </div>

                    <div class="col-lg-4">
                        <label class="form-label">{{ 'FORMS.MAX_PARTICIPANTS' | translate }} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="1" min="1"
                               formControlName="max_participants"
                               (input)="onMaxParticipantsChange()"
                               [ngClass]="{ 'is-invalid': (submitted || f['max_participants'].touched) && f['max_participants'].errors }">
                        <div *ngIf="(submitted || f['max_participants']?.touched) && f['max_participants'].errors" class="invalid-feedback">
                            <div *ngIf="f['max_participants'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['max_participants'].errors?.['min']">{{ 'VALIDATION.MAX_PARTICIPANTS_MIN' | translate }}</div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.MINIMUM' | translate }}: 1 {{ 'VIEW_ACTIVITY.PARTICIPANT' | translate }}</small>
                    </div>

                    <!-- Location -->
                    <div class="col-12 mt-4">
                        <h5 class="mb-3">{{ 'VIEW_ACTIVITY.LOCATION' | translate }}</h5>
                    </div>

                    <div class="col-12">
                        <label class="form-label">{{ 'FORMS.ACTIVITY_ADDRESS' | translate }} *</label>
                        <input type="text" class="form-control" [placeholder]="'FORMS.ENTER_FULL_ADDRESS' | translate" 
                               formControlName="address"
                               [ngClass]="{ 'is-invalid': submitted && f['address'].errors }">
                        <div *ngIf="submitted && f['address'].errors" class="invalid-feedback">
                            <div *ngIf="f['address'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <label class="form-label">{{ 'FORMS.LATITUDE' | translate }} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="40.7128" step="any"
                               formControlName="latitude"
                               (input)="onLatitudeInput($event)"
                               [ngClass]="{ 'is-invalid': (submitted || f['latitude'].touched) && f['latitude'].errors }">
                        <div *ngIf="(submitted || f['latitude']?.touched) && f['latitude'].errors" class="invalid-feedback">
                            <div *ngIf="f['latitude'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['latitude'].errors?.['invalidLatitude']">{{ 'VALIDATION.INVALID_LATITUDE' | translate }}</div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.INVALID_LATITUDE' | translate }}</small>
                    </div>

                    <div class="col-lg-6">
                        <label class="form-label">{{ 'FORMS.LONGITUDE' | translate }} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="-74.0060" step="any"
                               formControlName="longitude"
                               (input)="onLongitudeInput($event)"
                               [ngClass]="{ 'is-invalid': (submitted || f['longitude'].touched) && f['longitude'].errors }">
                        <div *ngIf="(submitted || f['longitude']?.touched) && f['longitude'].errors" class="invalid-feedback">
                            <div *ngIf="f['longitude'].errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                            <div *ngIf="f['longitude'].errors?.['invalidLongitude']">{{ 'VALIDATION.INVALID_LONGITUDE' | translate }}</div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.INVALID_LONGITUDE' | translate }}</small>
                    </div>

                    <!-- Existing Images -->
                    <div class="col-12 mt-4" *ngIf="existingImages.length > 0">
                        <h5 class="mb-3">{{ 'FORMS.CURRENT_IMAGES' | translate }}</h5>
                        <div class="row g-3">
                            <div *ngFor="let image of existingImages; let i = index" class="col-md-3">
                                <div class="position-relative">
                                    <img [src]="image" class="img-fluid rounded shadow-sm" alt="Activity Image">
                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                                            (click)="removeExistingImage(i)">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Images -->
                    <div class="col-12 mt-4">
                        <h5 class="mb-3">{{ 'FORMS.ADD_NEW_IMAGES' | translate }}</h5>
                        <input type="file" class="form-control" multiple accept="image/*" 
                               (change)="onImageSelected($event)">
                        <small class="text-muted">{{ 'FORMS.SELECT_MULTIPLE_IMAGES_FOR_ACTIVITY' | translate }}</small>
                    </div>

                    <!-- Time Slots -->
                    <div class="col-12 mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">{{ 'FORMS.TIME_SLOTS' | translate }}</h5>
                            <button type="button" class="btn btn-primary btn-sm" (click)="addSlot()">
                                <i class="bi bi-plus me-1"></i>{{ 'FORMS.ADD_SLOT' | translate }}
                            </button>
                        </div>
                    </div>

                    <div formArrayName="slots">
                        <div *ngFor="let slot of slots.controls; let i = index" [formGroupName]="i" 
                             class="col-12 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">{{ 'FORMS.SLOT' | translate }} {{i + 1}}</h6>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                (click)="removeSlot(i)" [disabled]="slots.length === 1">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">{{ 'FORMS.START_TIME' | translate }} <span class="text-danger">*</span></label>
                                            <input type="datetime-local" class="form-control"
                                                   formControlName="start_time"
                                                   [min]="getMinDateTime()"
                                                   (change)="validateSlotDates(slot)"
                                                   [ngClass]="{ 'is-invalid': (submitted || slot.get('start_time')?.touched) && (slot.get('start_time')?.errors || slot.errors?.['pastDate']) }">
                                            <div *ngIf="(submitted || slot.get('start_time')?.touched) && (slot.get('start_time')?.errors || slot.errors?.['pastDate'])" class="invalid-feedback">
                                                <div *ngIf="slot.get('start_time')?.errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                                                <div *ngIf="slot.get('start_time')?.errors?.['pastDate'] || slot.errors?.['pastDate']">{{ 'VALIDATION.START_TIME_PAST' | translate }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">{{ 'FORMS.END_TIME' | translate }} <span class="text-danger">*</span></label>
                                            <input type="datetime-local" class="form-control"
                                                   formControlName="end_time"
                                                   [min]="slot.get('start_time')?.value || getMinDateTime()"
                                                   (change)="validateSlotDates(slot)"
                                                   [ngClass]="{ 'is-invalid': (submitted || slot.get('end_time')?.touched) && (slot.get('end_time')?.errors || slot.errors?.['endBeforeStart'] || slot.errors?.['pastDate']) }">
                                            <div *ngIf="(submitted || slot.get('end_time')?.touched) && (slot.get('end_time')?.errors || slot.errors?.['endBeforeStart'] || slot.errors?.['pastDate'])" class="invalid-feedback">
                                                <div *ngIf="slot.get('end_time')?.errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                                                <div *ngIf="slot.get('end_time')?.errors?.['pastDate'] || slot.errors?.['pastDate']">{{ 'VALIDATION.END_TIME_PAST' | translate }}</div>
                                                <div *ngIf="slot.get('end_time')?.errors?.['endBeforeStart'] || slot.errors?.['endBeforeStart']">{{ 'VALIDATION.END_TIME_BEFORE_START' | translate }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">{{ 'FORMS.AVAILABLE_SPOTS' | translate }} <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" placeholder="1" min="1"
                                                   formControlName="available_spots"
                                                   [max]="activityForm.get('max_participants')?.value || 999"
                                                   (input)="onAvailableSpotsChange(i)"
                                                   (blur)="onAvailableSpotsChange(i)"
                                                   [ngClass]="{ 'is-invalid': (submitted || slot.get('available_spots')?.touched) && slot.get('available_spots')?.errors }">
                                            <div *ngIf="(submitted || slot.get('available_spots')?.touched) && slot.get('available_spots')?.errors" class="invalid-feedback">
                                                <div *ngIf="slot.get('available_spots')?.errors?.['required']">{{ 'VALIDATION.REQUIRED' | translate }}</div>
                                                <div *ngIf="slot.get('available_spots')?.errors?.['min']">{{ 'VALIDATION.AVAILABLE_SPOTS_MIN' | translate }}</div>
                                                <div *ngIf="slot.get('available_spots')?.errors?.['exceedsMaxParticipants']">
                                                    {{ 'VALIDATION.AVAILABLE_SPOTS_EXCEED' | translate }}
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ 'COMMON.MAX' | translate }}: {{activityForm.get('max_participants')?.value || 0}} {{ 'VIEW_ACTIVITY.PARTICIPANT' | translate }}s</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="col-12">
                        <div class="d-sm-flex justify-content-end">
                            <button type="button" class="btn btn-light me-2" (click)="goBack()">{{ 'COMMON.CANCEL' | translate }}</button>
                            <button type="submit" class="btn btn-primary">{{ 'COMMON.UPDATE' | translate }} {{ 'SIDEBAR.ACTIVITIES' | translate }}</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
