<ngx-spinner bdColor="rgba(51,51,51,0.8)" size="medium" color="#fff" type="ball-scale-multiple" [fullScreen]="true">
    <p style="font-size: 30px; color: white">{{ 'LIST.FETCHING_DATA' | translate }}</p>
</ngx-spinner>
<div class="row mb-3">
    <div class="col-12 d-sm-flex justify-content-between align-items-center">
        <h1 class="h3 mb-2 mb-sm-0">{{ 'SIDEBAR.USERS' | translate }}</h1>
        <div class="d-flex gap-2">
            <select class="form-select" [(ngModel)]="selectedStatusFilter" (change)="applyStatusFilter()" style="width: auto;">
                <option value="">{{ 'LIST.ALL_STATUS' | translate }}</option>
                <option value="active">{{ 'LIST.ACTIVE' | translate }}</option>
                <option value="blocked">{{ 'LIST.BLOCKED' | translate }}</option>
                <option value="pending">{{ 'LIST.PENDING' | translate }}</option>
            </select>
            <select class="form-select" [(ngModel)]="selectedFilter" (change)="applyFilter()" style="width: auto;">
                <option *ngFor="let option of filterOptions" [value]="option.value">
                    {{ option.label | translate }}
                </option>
            </select>
            <button class="btn btn-primary" (click)="showRewardDialog()">{{ 'LIST.ADD_SUB_ADMIN' | translate }}</button>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-sm-4 col-lg-4">
        <div class="text-center p-4 bg-primary bg-opacity-10 border border-primary rounded-3">
            <h6>{{ 'LIST.TOTAL_USERS' | translate }}</h6>
            <h2 class="mb-0 fs-1 text-primary">{{counters.users}}</h2>
        </div>
    </div>
    <div class="col-sm-4 col-lg-4">
        <div class="text-center p-4 bg-success bg-opacity-10 border border-success rounded-3">
            <h6>{{ 'LIST.ACTIVE' | translate }}</h6>
            <h2 class="mb-0 fs-1 text-success">{{counters.active}}</h2>
        </div>
    </div>
    <div class="col-sm-4 col-lg-4">
        <div class="text-center p-4  bg-warning bg-opacity-15 border border-warning rounded-3">
            <h6>{{ 'LIST.INACTIVE' | translate }}</h6>
            <h2 class="mb-0 fs-1 text-warning">{{counters.inactive}}</h2>
        </div>
    </div>
</div>
<div class="card bg-transparent border">
    <div class="card-body mt-2">
        <div class="table-responsive border-0 rounded-3" *ngIf="filteredUsers.length > 0; else noUsersTemplate">
            <table datatable [dtOptions]="dtOptions" class="table table-hover align-middle mb-0 modern-table"
                id="dtable">
                <thead class="table-header">
                    <tr>
                        <th scope="col" class="border-0 fw-bold text-uppercase">
                            <i class="bi bi-hash me-2"></i>{{ 'LIST.SERIAL_NO' | translate }}
                        </th>
                        <th scope="col" class="border-0 fw-bold text-uppercase">
                            <i class="bi bi-person me-2"></i>{{ 'FORMS.USERNAME' | translate }}
                        </th>
                        <th scope="col" class="border-0 fw-bold text-uppercase">
                            <i class="bi bi-circle-fill me-2"></i>{{ 'COMMON.STATUS' | translate }}
                        </th>
                        <th scope="col" class="border-0 fw-bold text-uppercase">
                            <i class="bi bi-tag me-2"></i>{{ 'LIST.TYPE' | translate }}
                        </th>
                        <th scope="col" class="border-0 fw-bold text-uppercase text-center">
                            <i class="bi bi-gear me-2"></i>{{ 'COMMON.ACTIONS' | translate }}
                        </th>
                        <th scope="col" class="border-0 fw-bold text-uppercase text-center rounded-end">
                            <i class="bi bi-lock me-2"></i>{{ 'LIST.STATUS_CONTROL' | translate }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let q of filteredUsers; let i = index; trackBy: trackByUserId" class="table-row">
                        <td class="text-center">
                            <span class="fw-semibold text-dark">{{i + 1}}</span>
                        </td>
                        <td class="user-cell">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    <i class="bi bi-person-circle fs-4 text-primary"></i>
                                </div>
                                <div>
                                    <span class="fw-semibold text-dark">{{q.username}}</span>
                                </div>
                            </div>
                        </td>
                        
                        <td>
                            <div class="d-flex flex-wrap gap-1 align-items-center">
                                <!-- Normal Status -->
                                <div *ngIf="q.status == 'active'"
                                    class="badge bg-success bg-opacity-15 text-success px-2 py-1 rounded-pill">
                                    <i class="bi bi-check-circle me-1"></i>{{ 'LIST.ACTIVE' | translate }}
                                </div>
                                <div *ngIf="q.status == 'blocked'"
                                    class="badge bg-danger bg-opacity-15 text-danger px-2 py-1 rounded-pill">
                                    <i class="bi bi-x-circle me-1"></i>{{ 'LIST.BLOCKED' | translate }}
                                </div>
                                <div *ngIf="q.status == 'pending'"
                                    class="badge bg-warning bg-opacity-15 text-warning px-2 py-1 rounded-pill">
                                    <i class="bi bi-clock me-1"></i>{{ 'LIST.PENDING' | translate }}
                                </div>
                                
                                <!-- Approval Status Badge -->
                                <div *ngIf="q.approval_status && q.approval_status !== q.status" class="ms-1">
                                    <div *ngIf="q.approval_status == 'pending'"
                                        class="badge bg-warning bg-opacity-10 text-warning px-2 py-1 rounded-pill small">
                                        <i class="bi bi-clock me-1"></i>{{ 'LIST.APP' | translate }}: {{ 'LIST.PENDING' | translate }}
                                    </div>
                                    <div *ngIf="q.approval_status == 'approved'"
                                        class="badge bg-success bg-opacity-10 text-success px-2 py-1 rounded-pill small">
                                        <i class="bi bi-check-circle me-1"></i>{{ 'LIST.APP' | translate }}: {{ 'LIST.APPROVED' | translate }}
                                    </div>
                                    <div *ngIf="q.approval_status == 'rejected'"
                                        class="badge bg-danger bg-opacity-10 text-danger px-2 py-1 rounded-pill small">
                                        <i class="bi bi-x-circle me-1"></i>{{ 'LIST.APP' | translate }}: {{ 'LIST.REJECTED' | translate }}
                                    </div>
                                    <div *ngIf="q.approval_status == 'blocked'"
                                        class="badge bg-danger bg-opacity-10 text-danger px-2 py-1 rounded-pill small">
                                        <i class="bi bi-lock me-1"></i>{{ 'LIST.APP' | translate }}: {{ 'LIST.BLOCKED' | translate }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span *ngIf="isPartner(q) && getPartnerCommissionRate(q) !== null" class="badge bg-secondary bg-opacity-25 text-secondary me-1">{{ getPartnerCommissionRate(q) }}%</span>
                            <div *ngIf="q?.user_role === 'admin' || q?.type === 'admin'" 
                                 class="badge bg-primary bg-opacity-15 text-primary px-3 py-2 rounded-pill">
                                <i class="bi bi-shield-check me-1"></i>{{ 'LIST.ADMIN' | translate }}
                            </div>
                            <div *ngIf="q?.user_role === 'subadmin' || q?.type === 'subadmin'" 
                                 class="badge bg-secondary bg-opacity-15 text-secondary px-3 py-2 rounded-pill">
                                <i class="bi bi-person-gear me-1"></i>{{ 'LIST.SUB_ADMIN' | translate }}
                            </div>
                            <div *ngIf="q?.user_role === 'user' || q?.type === 'user'" 
                                 class="badge bg-info bg-opacity-15 text-info px-3 py-2 rounded-pill">
                                <i class="bi bi-person me-1"></i>{{ 'LIST.USER' | translate }}
                            </div>
                            <div *ngIf="q?.user_role === 'family' || q?.type === 'family'" 
                                 class="badge bg-success bg-opacity-15 text-success px-3 py-2 rounded-pill">
                                <i class="bi bi-house-heart me-1"></i>{{ 'LIST.FAMILY' | translate }}
                            </div>
                            <div *ngIf="q?.user_role === 'partner' || q?.type === 'partner'" 
                                 class="badge bg-warning bg-opacity-15 text-warning px-3 py-2 rounded-pill">
                                <i class="bi bi-handshake me-1"></i>{{ 'LIST.PARTNER' | translate }}
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-danger btn-sm rounded-pill me-1"
                                    (click)="deleteExamModal(q.id)"
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="top" 
                                    data-bs-title="Delete User">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button *ngIf="(q.user_role === 'partner' || q.user_role === 'family' || q.type === 'partner' || q.type === 'family') && (q.approval_status === 'pending' || q.status === 'pending')" 
                                        class="btn btn-outline-success btn-sm rounded-pill me-1"
                                        [ngClass]="{'btn-success': lastActionUserId === q.id && lastActionType === 'approved'}"
                                        (click)="approveUser(q.id)"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        data-bs-title="Approve User">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                <button *ngIf="(q.user_role === 'partner' || q.user_role === 'family' || q.type === 'partner' || q.type === 'family') && (q.approval_status === 'pending' || q.status === 'pending')" 
                                        class="btn btn-outline-danger btn-sm rounded-pill"
                                        [ngClass]="{'btn-danger': lastActionUserId === q.id && lastActionType === 'rejected'}"
                                        (click)="rejectUser(q.id)"
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        data-bs-title="Reject User">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                                <button *ngIf="canSetPartnerCommission && isPartner(q)"
                                        class="btn btn-outline-secondary btn-sm rounded-pill ms-1"
                                        (click)="openSetCommissionModal(q)"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        [attr.data-bs-title]="'LIST.SET_COMMISSION' | translate">
                                    <i class="bi bi-percent"></i>
                                </button>
                                <button *ngIf="isPartner(q)"
                                        class="btn btn-outline-info btn-sm rounded-pill ms-1"
                                        (click)="openViewPartnerProfile(q)"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        [attr.data-bs-title]="'LIST.VIEW_PROFILE' | translate">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-center">
                            <!-- Show Block button if user is active and not blocked/rejected -->
                            <button *ngIf="q.status == 'active' && q.approval_status !== 'blocked' && q.approval_status !== 'rejected'" 
                                    class="btn btn-outline-warning btn-sm rounded-pill px-3"
                                    (click)="blockUser(q.id, 'block')"
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="top" 
                                    [attr.data-bs-title]="'LIST.BLOCK' | translate">
                                <i class="bi bi-lock me-1"></i>{{ 'LIST.BLOCK' | translate }}
                            </button>
                            
                            <!-- Show Activate button if user is blocked (by status or approval_status) -->
                            <button *ngIf="q.status == 'blocked' || q.approval_status == 'blocked' || q.approval_status == 'rejected'" 
                                    class="btn btn-outline-success btn-sm rounded-pill px-3"
                                    (click)="blockUser(q.id, 'unblock')"
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="top" 
                                    [attr.data-bs-title]="'LIST.UNBLOCK' | translate">
                                <i class="bi bi-unlock me-1"></i>{{ 'LIST.UNBLOCK' | translate }}
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <ng-template #noUsersTemplate>
            <div class="text-center p-5">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-3 mb-0">No users found</p>
            </div>
        </ng-template>
    </div>
</div>

<div class="modal fade" id="addProfession" tabindex="-1" aria-labelledby="appDetaillabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark">
                <h5 class="modal-title text-white" id="appDetaillabel">{{ 'LIST.ADD_SUB_ADMIN' | translate }}</h5>
                <button type="button" class="btn btn-sm btn-light mb-0" data-bs-dismiss="modal" aria-label="Close"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body p-5">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" placeholder="Email" id="email" 
                               maxlength="100" required>
                        <small class="text-muted">Enter a valid email address</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" placeholder="Password" id="password" 
                               minlength="6" maxlength="50" required>
                        <small class="text-muted">Password must be between 6 and 50 characters</small>
                        <br />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" placeholder="Username" id="username" 
                               minlength="3" maxlength="50" required>
                        <small class="text-muted">Username must be between 3 and 50 characters</small>
                    </div>
             
                    <div class="col-md-6">
                        <label class="form-label">Allowed Quests? <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="Allowed Quests?" id="allowed_quest" 
                               value="1" min="1" step="1" required
                               (input)="validateNumberInput($event, 'allowed_quest')"
                               (keydown)="preventNegativeInput($event)">
                        <small class="text-muted">Must be at least 1</small>
                        <br />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Allowed Hunts? <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="Allowed Hunts?" id="allowed_hunt" 
                               value="1" min="1" step="1" required
                               (input)="validateNumberInput($event, 'allowed_hunt')"
                               (keydown)="preventNegativeInput($event)">
                        <small class="text-muted">Must be at least 1</small>
                        <br />
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">{{ 'FORMS.PERMISSIONS' | translate }} <span class="text-danger">*</span></label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check radio-bg-light" *ngFor="let perm of permissionList">
                                <input class="form-check-input"
                                       type="checkbox"
                                       [id]="perm.id"
                                       [value]="perm.value"
                                       (change)="onPermissionChange($event)">
                                <label class="form-check-label" [for]="perm.id">
                                  {{ perm.label | translate }}
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">{{ 'VALIDATION.AT_LEAST_ONE_PERMISSION' | translate }}</small>
                        <br />
                    </div>
                    
                </div>
                <br />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary-soft my-0" (click)="saveRequest()">Save</button>
                <button type="button" class="btn btn-danger-soft my-0" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Set Partner Commission Modal (Admin only) -->
<div class="modal fade" id="setCommissionModal" tabindex="-1" aria-labelledby="setCommissionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark">
        <h5 class="modal-title text-white" id="setCommissionModalLabel">{{ 'LIST.SET_COMMISSION' | translate }}</h5>
        <button type="button" class="btn btn-sm btn-light mb-0" data-bs-dismiss="modal" aria-label="Close" (click)="closeSetCommissionModal()"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <p *ngIf="selectedPartnerForCommission" class="text-muted small mb-3">
          {{ 'LIST.PARTNER' | translate }}: <strong>{{ selectedPartnerForCommission.username }}</strong>
        </p>
        <div class="mb-3">
          <label class="form-label">{{ 'FORMS.COMMISSION_RATE' | translate }} (%)</label>
          <input type="number" class="form-control" min="0" max="100" step="0.01" placeholder="15"
                 [(ngModel)]="commissionRateInput"
                 (keydown)="preventNegativeInput($event)">
          <small class="text-muted">0–100</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" [disabled]="savingCommission" (click)="savePartnerCommission()">
          <span *ngIf="savingCommission">{{ 'COMMON.LOADING' | translate }}</span>
          <span *ngIf="!savingCommission">{{ 'COMMON.UPDATE' | translate }}</span>
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="closeSetCommissionModal()">{{ 'COMMON.CANCEL' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<!-- View Partner Profile Modal (about, gallery, background) -->
<div class="modal fade" id="viewPartnerProfileModal" tabindex="-1" aria-labelledby="viewPartnerProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark">
        <h5 class="modal-title text-white" id="viewPartnerProfileModalLabel">
          <i class="bi bi-person-badge me-2"></i>{{ 'LIST.VIEW_PROFILE' | translate }}
          <span *ngIf="selectedPartnerForView" class="ms-2 text-white-50">— {{ selectedPartnerForView.username }}</span>
        </h5>
        <button type="button" class="btn btn-sm btn-light mb-0" data-bs-dismiss="modal" aria-label="Close" (click)="closeViewPartnerProfile()"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <div *ngIf="loadingProfileView" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">{{ 'COMMON.LOADING' | translate }}</p>
        </div>
        <div *ngIf="partnerProfileViewError && !loadingProfileView" class="alert alert-warning mb-0">
          {{ partnerProfileViewError }}
        </div>
        <div *ngIf="partnerProfileView && !loadingProfileView && !partnerProfileViewError" class="partner-profile-details">
          <!-- Background preview -->
          <div *ngIf="getPartnerProfileBackground()" class="mb-4 rounded overflow-hidden border" style="height: 100px;" [ngStyle]="getPartnerProfileBackgroundStyle()"></div>

          <!-- Basic & business info -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <dl class="row mb-0 small">
                <dt class="col-sm-4 text-muted">{{ 'COMMON.EMAIL' | translate }}</dt>
                <dd class="col-sm-8">{{ getPartnerProfileEmail() }}</dd>
                <dt class="col-sm-4 text-muted">{{ 'PARTNER_PROFILE.BUSINESS_NAME' | translate }}</dt>
                <dd class="col-sm-8">{{ getPartnerProfileBusinessName() }}</dd>
                <dt class="col-sm-4 text-muted">{{ 'COMMON.PHONE' | translate }}</dt>
                <dd class="col-sm-8">{{ getPartnerProfilePhone() }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row mb-0 small">
                <dt class="col-sm-4 text-muted">{{ 'FORMS.COMMISSION_RATE' | translate }}</dt>
                <dd class="col-sm-8">{{ getPartnerProfileCommissionRate() !== null ? getPartnerProfileCommissionRate() + '%' : '—' }}</dd>
                <dt class="col-sm-4 text-muted">{{ 'LIST.APPROVAL_STATUS' | translate }}</dt>
                <dd class="col-sm-8"><span class="badge bg-secondary">{{ getPartnerProfileApprovalStatus() }}</span></dd>
                <dt class="col-sm-4 text-muted">{{ 'PARTNER_PROFILE.MAP_LOCATION' | translate }}</dt>
                <dd class="col-sm-8 font-monospace">{{ getPartnerProfileMapCoordinates() }}</dd>
              </dl>
            </div>
          </div>

          <h6 class="text-uppercase text-muted small mb-2">{{ 'PARTNER_PROFILE.BUSINESS_DESCRIPTION' | translate }}</h6>
          <p class="small text-break mb-4">{{ getPartnerProfileBusinessDescription() }}</p>

          <!-- About -->
          <h6 class="text-uppercase text-muted small mb-2">{{ 'PARTNER_PROFILE.ABOUT' | translate }}</h6>
          <div class="mb-4">
            <p *ngIf="getPartnerProfileAbout()" class="mb-0 text-break">{{ getPartnerProfileAbout() }}</p>
            <p *ngIf="!getPartnerProfileAbout()" class="text-muted mb-0 small">{{ 'PARTNER_PROFILE.NO_ABOUT' | translate }}</p>
          </div>

          <!-- Layout background (value) -->
          <h6 class="text-uppercase text-muted small mb-2">{{ 'PARTNER_PROFILE.BACKGROUND' | translate }}</h6>
          <p class="small mb-4 font-monospace">{{ getPartnerProfileBackground() || '—' }}</p>

          <!-- Gallery -->
          <h6 class="text-uppercase text-muted small mb-2">{{ 'PARTNER_PROFILE.GALLERY' | translate }}</h6>
          <div class="d-flex flex-wrap gap-2">
            <div *ngFor="let url of getPartnerProfileGallery()" class="gallery-thumb-wrap">
              <img [src]="url" alt="Gallery" class="rounded border" style="width: 80px; height: 80px; object-fit: cover;" onerror="this.style.display='none'">
            </div>
            <p *ngIf="getPartnerProfileGallery().length === 0" class="text-muted small mb-0">{{ 'PARTNER_PROFILE.NO_GALLERY' | translate }}</p>
          </div>
        </div>
      </div>
      <div class="modal-footer" *ngIf="partnerProfileView || partnerProfileViewError">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="closeViewPartnerProfile()">{{ 'COMMON.CLOSE' | translate }}</button>
      </div>
    </div>
  </div>
</div>
